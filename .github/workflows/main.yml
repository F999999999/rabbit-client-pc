# å·¥ä½œæµåç§°ï¼ˆé»˜è®¤å€¼ï¼šé…ç½®æ–‡ä»¶åï¼‰
name: GitHub Actions Deploy rabbit-client-pc main

# æŒ‡å®šè§¦å‘ å·¥ä½œæµï¼ˆworkflowï¼‰ çš„æ¡ä»¶
# æŒ‡å®šè§¦å‘äº‹ä»¶æ—¶ï¼Œå¯ä»¥é™å®šåˆ†æ”¯æˆ–æ ‡ç­¾
on:
  # å½“è§¦å‘ push äº‹ä»¶æ—¶æ‰§è¡Œå·¥ä½œæµä»»åŠ¡
  push:
    # å½“åˆ†æ”¯æ˜¯ main æ—¶æ‰§è¡Œå·¥ä½œæµä»»åŠ¡
    branches:
      - main

# å·¥ä½œæµä»»åŠ¡
jobs:
  # ä»»åŠ¡åç§°
  build:
    # ä»»åŠ¡è¿è¡Œçš„å®¹å™¨ç±»å‹ï¼ˆè™šæ‹Ÿæœºç¯å¢ƒï¼‰
    runs-on: ubuntu-latest

    # åˆ¤æ–­åœ¨æŒ‡å®šç”¨æˆ·æˆ–è€…ç»„ç»‡çš„æŒ‡å®šä»“åº“ä¸­æ‰æ‰§è¡Œ
    if: github.repository == 'F999999999/rabbit-client-pc'
    # åˆ¤æ–­åœ¨æŒ‡å®šç”¨æˆ·æˆ–è€…ç»„ç»‡ä¸­æ‰æ‰§è¡Œ
    # if: github.repository_owner == 'ç”¨æˆ·åï¼ˆç»„ç»‡åï¼‰'

    # æŒ‡å®šä»»åŠ¡æ‰§è¡Œçš„å‘½ä»¤
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2
        with:
          # æ˜¯å¦åœ¨git config ä¸­æŒä¹…åŒ–tokenï¼ˆé»˜è®¤å€¼ï¼štrueï¼‰
          persist-credentials: false

      # è®¾ç½® node ç¯å¢ƒå˜é‡
      - name: Setup Node.js âš™
        uses: actions/setup-node@v1
        with:
          # éœ€è¦ä½¿ç”¨çš„ node ç‰ˆæœ¬
          node-version: '14'

      # ç¼“å­˜ node_modules
      - name: Cache dependencies ğŸ“¦
        uses: actions/cache@v2
        id: yarn-cache
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      # å¦‚æœç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œå®‰è£…ä¾èµ–
      - name: Install dependencies ğŸ”§
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn --frozen-lockfile

      # è¿è¡Œæ„å»ºè„šæœ¬
      - name: Build â³
        run: yarn build

      # éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: Deploy ğŸš€
        # æ„å»º
        uses: easingthemes/ssh-deploy@v2.1.5
        # è¯¥æ­¥éª¤æ‰€éœ€çš„ç¯å¢ƒå˜é‡
        env:
          # æœåŠ¡å™¨ SSH ç§é’¥
          SSH_PRIVATE_KEY: ${{ secrets.REMOTE_SSH_KEY }}
          # æœåŠ¡å™¨åœ°å€(IPæˆ–è€…åŸŸå)
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          # æœåŠ¡å™¨ç”¨æˆ·å
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          # æœåŠ¡å™¨éƒ¨ç½²è·¯å¾„
          TARGET: ${{ secrets.REMOTE_TARGET }}
          # æºç›®å½•ï¼ˆæ‰“åŒ…çš„ç›®å½•ï¼‰
          SOURCE: "dist/"
          # rsync flagsï¼ˆé»˜è®¤å€¼ï¼š"-rltgoDzvO"ï¼‰
          # --delete åˆ é™¤é‚£äº›ç›®æ ‡ç›®å½•ä¸­æœ‰è€Œæºç›®å½•ä¸­æ²¡æœ‰çš„å¤šä½™æ–‡ä»¶
          # --exclude æ’é™¤ç›®æ ‡ç›®å½•ä¸­é‚£äº›è¢«è¯¥é€‰é¡¹æŒ‡å®šçš„æ–‡ä»¶
          ARGS: "-rltgoDzvO --delete --exclude '.user.ini'"